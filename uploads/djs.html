<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DJ Upload</title>

  <!-- Load CSS from MAIN SITE -->
  <link rel="stylesheet" href="https://dance-offs.com/style2.css?v=2004">
</head>

<body class="dj-upload">

  <div class="dj-booth">

    <!-- DECKS -->
    <div class="deck-row">

      <div class="deck">
        <div class="deck-title">Deck 1</div>
        <input type="text" id="deck1Artist" placeholder="Artist" required>
        <input type="text" id="deck1Title" placeholder="Track Title" required>
      </div>

      <div class="deck">
        <div class="deck-title">Deck 2</div>
        <input type="text" id="deck2Artist" placeholder="Artist" required>
        <input type="text" id="deck2Title" placeholder="Track Title" required>
      </div>

    </div>

    <!-- MIXER -->
    <div class="mixer">
      <input type="email" id="djEmail" placeholder="Your Email (DJ ID)" required>
      <input type="text" id="djName" placeholder="DJ Name" required>

      <label class="upload-label">
        Upload MP3 only <span style="color:#fff;">(~10 minutes max)</span>
      </label>

      <input type="file" id="djFile" accept=".mp3,audio/mpeg" required>

      <button id="uploadBtn" class="upload-button">Upload Mix</button>

      <div id="uploadStatus"></div>
    </div>

  </div>

  <!-- UPLOAD + GOOGLE SHEET SCRIPT -->
  <script>
    const BACKEND_URL =
      "https://script.google.com/macros/s/AKfycbxUMisR1LVFdL2n6COU-DlYXBLesPSJAVLofrAvZqYapgTRr--ybmKWZYqSY5S0rncj/exec";

    document.getElementById("uploadBtn").addEventListener("click", async () => {
      const status = document.getElementById("uploadStatus");
      status.innerHTML = "Uploading...";

      const fileInput = document.getElementById("djFile");
      if (!fileInput.files.length) {
        status.innerHTML = "Please select an MP3 file.";
        return;
      }

      const file = fileInput.files[0];

      // Build form data for PHP upload
      const formData = new FormData();
      formData.append("file", file);

      try {
        // 1️⃣ Upload MP3 to PHP
        const uploadResponse = await fetch("/uploads/upload.php", {
          method: "POST",
          body: formData
        });

        const fileUrl = await uploadResponse.text(); // PHP returns the public URL
        status.innerHTML = "Upload complete! Logging metadata...";

        // Extract stored filename from URL
        const storedName = fileUrl.split("/").pop();

        // 2️⃣ Send metadata to Google Sheets via backend
        await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            mode: "djupload",

            djEmail: document.getElementById("djEmail").value,
            djName: document.getElementById("djName").value,

            deck1Artist: document.getElementById("deck1Artist").value,
            deck1Title: document.getElementById("deck1Title").value,
            deck2Artist: document.getElementById("deck2Artist").value,
            deck2Title: document.getElementById("deck2Title").value,

            fileUrl: fileUrl,
            originalName: file.name,
            storedName: storedName,
            sizeBytes: file.size,
            mimeType: file.type,
            status: "active"
          })
        });

        status.innerHTML = "Mix uploaded and logged successfully!";
      } catch (err) {
        console.error(err);
        status.innerHTML = "Upload failed.";
      }
    });
  </script>

</body>
</html>
