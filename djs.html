<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DJs</title>
  <link rel="stylesheet" href="style2.css">
</head>

<body>

  <div class="navbar">
    <a href="index.html">Home</a>
    <a href="dancers.html">Dancers</a>
    <a href="battle.html">Battle</a>
    <a href="djs.html" class="active">DJs</a>
    <a href="vote.html">Vote</a>
    <a href="merch.html">Merch</a>
  </div>

  <div class="page-container">
    <h1>Submit Your DJ Mix</h1>

    <div class="battle-card" style="max-width:600px;">

      <label>SoundCloud Mix URL</label>
      <input id="scURL" class="input-field" type="text" placeholder="https://soundcloud.com/..." oninput="updatePreview()">

      <div id="previewPlayer" style="margin-top:20px; display:none;">
        <iframe 
          id="scPlayerFrame"
          width="100%" 
          height="120" 
          scrolling="no" 
          frameborder="no" 
          allow="autoplay">
        </iframe>
      </div>

      <button class="vote-button" style="margin-top:20px;" onclick="submitDJ()">
        Submit Mix
      </button>

      <p id="status" style="text-align:center; margin-top:15px; color:#0077cc;"></p>

    </div>
  </div>

  <script>
    const BASE_URL =
      "https://script.google.com/macros/s/AKfycbyfiIlExm-_OC9ULZHPaNkIaJ7RWKRDbkTSplu6_8A37cEy5Ph1YAdjF58dwF3uEntOdQ/exec";

    /* ------------------------------
       OLD WORKING FUNCTIONS RESTORED
    ------------------------------ */

    function extractUrlFromInput(raw) {
      let text = raw.trim();
      if (text.includes("<iframe")) {
        const srcMatch = text.match(/src="([^"]+)"/i);
        if (srcMatch) text = srcMatch[1];
      }
      return text;
    }

    function getInnerUrlIfPlayer(url) {
      if (url.includes("w.soundcloud.com/player")) {
        try {
          const u = new URL(url);
          const inner = u.searchParams.get("url");
          if (inner) return decodeURIComponent(inner);
        } catch (e) {}
      }
      return url;
    }

    async function resolveViaOEmbed(url) {
      try {
        const oembedUrl = "https://soundcloud.com/oembed?format=json&url=" + encodeURIComponent(url);
        const res = await fetch(oembedUrl);
        if (!res.ok) return url;

        const data = await res.json();
        const html = data.html || "";
        const srcMatch = html.match(/src="([^"]+)"/i);
        if (!srcMatch) return url;

        let playerUrl = srcMatch[1];
        playerUrl = getInnerUrlIfPlayer(playerUrl);
        return playerUrl || url;
      } catch (e) {
        return url;
      }
    }

    /* ------------------------------ */

    async function expandSoundCloudURL(url) {
      url = extractUrlFromInput(url);

      if (!url.startsWith("http")) {
        url = "https://" + url;
      }

      if (url.includes("on.soundcloud.com") || url.includes("snd.sc")) {
        url = await resolveViaOEmbed(url);
      }

      url = getInnerUrlIfPlayer(url);
      return url;
    }

    async function getNextSide() {
      const res = await fetch(BASE_URL + "?mode=readdj&cache=" + Math.random());
      const data = await res.json();
      if (!data || data.length === 0) return "DJ Left";
      const last = data[data.length - 1].DJ.toLowerCase();
      return last.includes("left") ? "DJ Right" : "DJ Left";
    }

    async function updatePreview() {
      let url = document.getElementById("scURL").value.trim();
      const preview = document.getElementById("previewPlayer");
      const frame = document.getElementById("scPlayerFrame");

      if (!url.includes("soundcloud.com")) {
        preview.style.display = "none";
        return;
      }

      url = await expandSoundCloudURL(url);

      const embedURL =
        "https://w.soundcloud.com/player/?url=" +
        encodeURIComponent(url) +
        "&color=%230077cc&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false";

      frame.src = embedURL;
      preview.style.display = "block";
    }

    async function submitDJ() {
      let url = document.getElementById("scURL").value.trim();
      const status = document.getElementById("status");

      url = await expandSoundCloudURL(url);

      if (!url.includes("soundcloud.com") && !url.includes("api.soundcloud.com")) {
        status.textContent = "Invalid SoundCloud URL.";
        status.style.color = "red";
        return;
      }

      const side = await getNextSide();

      const logURL =
        BASE_URL +
        "?mode=logdj" +
        "&dj=" + encodeURIComponent(side) +
        "&soundcloud=" + encodeURIComponent(url);

      fetch(logURL, { method: "GET", mode: "no-cors" })
        .then(() => {
          status.textContent = "Mix submitted as " + side + "!";
          status.style.color = "#0077cc";
          document.getElementById("scURL").value = "";
          document.getElementById("previewPlayer").style.display = "none";
        })
        .catch(() => {
          status.textContent = "Error submitting mix.";
          status.style.color = "red";
        });
    }
  </script>

</body>
</html>
