<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DJs</title>
  <link rel="stylesheet" href="style2.css">
</head>

<body>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dancers</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #fff;
    }

    /* Navigation */
    nav {
      background-color: #000;
      padding: 15px;
    }

    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 20px;
    }

    nav a {
      color: #fff;
      text-decoration: none;
      font-size: 18px;
    }

    nav a:hover {
      color: #f39c12;
    }

    /* Hero Section */
    .hero {
      width: 100%;
      height: 350px;
      background: url('dancer-hero2.jpg') center/cover no-repeat;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .hero h1 {
      font-size: 48px;
      text-shadow: 0 0 10px #000;
    }

    /* Content */
    .content {
      padding: 40px;
      text-align: center;
    }

    .content h2 {
      font-size: 32px;
      margin-bottom: 20px;
    }

    .content p {
      font-size: 18px;
      line-height: 1.6;
      max-width: 700px;
      margin: 0 auto;
    }
  </style>
</head>

<body>

  <!-- Navigation -->
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="battle.html">Battle</a></li>
      <li><a href="vote.html">Vote</a></li>
    </ul>
  </nav>

  <!-- Hero Image -->
  <div class="hero">
    <h1>Dancers</h1>
  </div>

  <!-- Page Content -->
  <div class="content">
    <h2>Meet the Dancers</h2>
    <p>
      Explore the lineup of incredible dancers competing in this season’s battles.
      Each performer brings their own unique style, energy, and creativity to the stage.
    </p>
  </div>

</body>
</html>

  <div class="navbar">
    <a href="index.html">Home</a>
    <a href="dancers.html">Dancers</a>
    <a href="battle.html">Battle</a>
    <a href="djs.html" class="active">DJs</a>
    <a href="vote.html">Vote</a>
    <a href="merch.html">Merch</a>
  </div>

  <div class="page-container">
    <h1>Submit Your DJ Mix</h1>

    <div class="battle-card" style="max-width:600px;">

      <label>SoundCloud Mix URL</label>
      <input id="scURL" class="input-field" type="text" placeholder="https://soundcloud.com/...">

      <div id="previewPlayer" style="margin-top:20px; display:none;">
        <iframe 
          id="scPlayerFrame"
          width="100%" 
          height="300"
          scrolling="no" 
          frameborder="no" 
          allow="autoplay">
        </iframe>
      </div>

      <button class="vote-button" style="margin-top:20px;" onclick="submitDJ()">
        Submit Mix
      </button>

      <p id="status" style="text-align:center; margin-top:15px; color:#0077cc;"></p>

    </div>
  </div>

  <script>
    const BASE_URL =
      "https://script.google.com/macros/s/AKfycbyfiIlExm-_OC9ULZHPaNkIaJ7RWKRDbkTSplu6_8A37cEy5Ph1YAdjF58dwF3uEntOdQ/exec";

    /* ----------------------------------------------------
       EXACT WORKING LOGIC FROM YOUR OLD LOADER
    ---------------------------------------------------- */

    function extractUrlFromInput(raw) {
      let text = raw.trim();
      if (text.includes("<iframe")) {
        const srcMatch = text.match(/src="([^"]+)"/i);
        if (srcMatch) text = srcMatch[1];
      }
      return text;
    }

    function getInnerUrlIfPlayer(url) {
      if (url.includes("w.soundcloud.com/player")) {
        try {
          const u = new URL(url);
          const inner = u.searchParams.get("url");
          if (inner) return decodeURIComponent(inner);
        } catch (e) {}
      }
      return url;
    }

    async function resolveViaOEmbed(url) {
      try {
        const oembedUrl = "https://soundcloud.com/oembed?format=json&url=" + encodeURIComponent(url);
        const res = await fetch(oembedUrl);
        if (!res.ok) return url;

        const data = await res.json();
        const html = data.html || "";
        const srcMatch = html.match(/src="([^"]+)"/i);
        if (!srcMatch) return url;

        let playerUrl = srcMatch[1];
        playerUrl = getInnerUrlIfPlayer(playerUrl);
        return playerUrl || url;
      } catch (e) {
        return url;
      }
    }

    async function expandSoundCloudURL(url) {
      url = extractUrlFromInput(url);

      if (!url.startsWith("http")) {
        url = "https://" + url;
      }

      if (url.includes("on.soundcloud.com") || url.includes("snd.sc")) {
        url = await resolveViaOEmbed(url);
      }

      url = getInnerUrlIfPlayer(url);

      if (url.includes("soundcloud.com") && !url.includes("api.soundcloud.com")) {
        url = url.split("?")[0];
      }

      return url;
    }

    async function getNextSide() {
      const res = await fetch(BASE_URL + "?mode=readdj&cache=" + Math.random());
      const data = await res.json();
      if (!data || data.length === 0) return "DJ Left";
      const last = data[data.length - 1].DJ.toLowerCase();
      return last.includes("left") ? "DJ Right" : "DJ Left";
    }

    /* ----------------------------------------------------
       SUBMIT → EXPAND → VALIDATE → LOAD PLAYER → AUTOPLAY → TIMESTAMP
    ---------------------------------------------------- */

    async function submitDJ() {
      const raw = document.getElementById("scURL").value.trim();
      const status = document.getElementById("status");
      const preview = document.getElementById("previewPlayer");
      const frame = document.getElementById("scPlayerFrame");

      status.textContent = "Processing...";
      status.style.color = "#0077cc";

      if (!raw) {
        status.textContent = "Please paste a SoundCloud URL first.";
        status.style.color = "red";
        return;
      }

      // EXPAND FIRST (critical)
      let url = await expandSoundCloudURL(raw);

      // VALIDATE AFTER EXPANSION (matches your working loader)
      if (!url.includes("soundcloud.com") && !url.includes("api.soundcloud.com")) {
        status.textContent = "Invalid SoundCloud URL.";
        status.style.color = "red";
        return;
      }

      const side = await getNextSide();

      // LOAD PLAYER WITH AUTOPLAY (visual mode)
      const embedURL =
        "https://w.soundcloud.com/player/?url=" +
        encodeURIComponent(url) +
        "&auto_play=true&visual=true";

      frame.src = embedURL;
      preview.style.display = "block";

      // LOG TO BACKEND
      const logURL =
        BASE_URL +
        "?mode=logdj" +
        "&dj=" + encodeURIComponent(side) +
        "&soundcloud=" + encodeURIComponent(url);

      fetch(logURL, { method: "GET", mode: "no-cors" })
        .then(() => {
          const now = new Date();
          const timeString = now.toLocaleTimeString();

          status.textContent = "Mix submitted as " + side + " at " + timeString;
          status.style.color = "#0077cc";

          document.getElementById("scURL").value = "";
        })
        .catch(() => {
          status.textContent = "Error submitting mix.";
          status.style.color = "red";
        });
    }
  </script>

</body>
</html>
