<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DJs</title>
  <link rel="stylesheet" href="style2.css">
</head>

<body>

  <!-- Navigation -->
  <div class="navbar">
    <a href="index.html">Home</a>
    <a href="dancers.html">Dancers</a>
    <a href="battle.html">Battle</a>
    <a href="djs.html" class="active">DJs</a>
    <a href="vote.html">Vote</a>
    <a href="merch.html">Merch</a>
  </div>

  <div class="page-container">
    <h1>Submit Your DJ Mix</h1>

    <div class="battle-card" style="max-width:600px;">

      <label>SoundCloud Mix URL</label>
      <input id="scURL" class="input-field" type="text" placeholder="https://soundcloud.com/..." oninput="updatePreview()">

      <!-- Live SoundCloud Preview -->
      <div id="previewPlayer" style="margin-top:20px; display:none;">
        <iframe 
          id="scPlayerFrame"
          width="100%" 
          height="120" 
          scrolling="no" 
          frameborder="no" 
          allow="autoplay">
        </iframe>
      </div>

      <button class="vote-button" style="margin-top:20px;" onclick="submitDJ()">
        Submit Mix
      </button>

      <p id="status" style="text-align:center; margin-top:15px; color:#0077cc;"></p>

    </div>
  </div>

  <script>
    const BASE_URL =
      "https://script.google.com/macros/s/AKfycbyfiIlExm-_OC9ULZHPaNkIaJ7RWKRDbkTSplu6_8A37cEy5Ph1YAdjF58dwF3uEntOdQ/exec";

    async function getNextSide() {
      const res = await fetch(BASE_URL + "?mode=readdj&cache=" + Math.random());
      const data = await res.json();

      if (!data || data.length === 0) {
        return "DJ Left";
      }

      const last = data[data.length - 1].DJ.toLowerCase();
      return last.includes("left") ? "DJ Right" : "DJ Left";
    }

    function updatePreview() {
      const url = document.getElementById("scURL").value.trim();
      const preview = document.getElementById("previewPlayer");
      const frame = document.getElementById("scPlayerFrame");

      if (!url.includes("soundcloud.com")) {
        preview.style.display = "none";
        return;
      }

      const embedURL =
        "https://w.soundcloud.com/player/?url=" +
        encodeURIComponent(url) +
        "&color=%230077cc&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false";

      frame.src = embedURL;
      preview.style.display = "block";
    }

    async function submitDJ() {
      const url = document.getElementById("scURL").value.trim();
      const status = document.getElementById("status");

      if (!url || !url.includes("soundcloud.com")) {
        status.textContent = "Please enter a valid SoundCloud URL.";
        status.style.color = "red";
        return;
      }

      const side = await getNextSide();

      const logURL =
        BASE_URL +
        "?mode=logdj" +
        "&dj=" + encodeURIComponent(side) +
        "&soundcloud=" + encodeURIComponent(url);

      fetch(logURL, { method: "GET", mode: "no-cors" })
        .then(() => {
          status.textContent = "Mix submitted as " + side + "!";
          status.style.color = "#0077cc";
          document.getElementById("scURL").value = "";
          document.getElementById("previewPlayer").style.display = "none";
        })
        .catch(() => {
          status.textContent = "Error submitting mix.";
          status.style.color = "red";
        });
    }
  </script>

</body>
</html>
