<script>
  let emailSubmitted = false;

  const urlParams = new URLSearchParams(window.location.search);
  const battleID = urlParams.get("battle");

  document.getElementById("navBar").classList.add("nav-disabled");

  window.addEventListener("beforeunload", function (e) {
    if (!emailSubmitted) {
      e.preventDefault();
      e.returnValue = "We need your email so we can notify you if you win!";
    }
  });

  function submitEmail() {
    const email = document.getElementById("emailInput").value.trim();
    const msg = document.getElementById("emailMessage");

    if (!email) {
      msg.innerText = "Please enter an email.";
      return;
    }

    // Store in Google Sheets
    fetch("https://script.google.com/macros/s/AKfycbwuOUEAuAE4CfauFw9Xxv3BJenwCUaUNakrb7DTeTjJLZMK8S1hCXbcLRBHCY3FoFZD_g/exec", {
      method: "POST",
      body: JSON.stringify({ 
        email: email,
        battle: battleID
      })
    });

    // Send confirmation email via EmailJS
    emailjs.send("service_sjny28j", "template_jv61djw", {
      name: email,          // REQUIRED
      email: email,         // REQUIRED
      title: battleID,      // REQUIRED
      battle: battleID      // REQUIRED
    })
    .then(() => {
      msg.innerText = "Thanks! Redirectingâ€¦";

      emailSubmitted = true;

      document.getElementById("navBar").classList.remove("nav-disabled");

      setTimeout(() => {
        window.location.href = "index.html";
      }, 1200);
    })
    .catch((err) => {
      msg.innerText = "Error sending email. Please try again.";
      console.error(err);
    });
  }
</script>
