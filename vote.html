async function loadBattles() {
  const container = document.getElementById("battleContainer");
  const soundcloudContainer = document.getElementById("soundcloudContainer");

  container.innerHTML = "<p>Loading battle...</p>";

  try {
    const response = await fetch(getDataURL());
    const rawData = await response.json();

    const voteCountsResponse = await fetch(getVoteCountsURL());
    const rawVotes = await voteCountsResponse.json();

    container.innerHTML = "";
    soundcloudContainer.innerHTML = "";

    // --- FILTER OUT BLANK ROWS ---
    const data = rawData.filter(row =>
      row &&
      row.left &&
      row.right &&
      row.left.trim() !== "" &&
      row.right.trim() !== ""
    );

    const voteCounts = rawVotes.filter(v =>
      v && (v.left !== undefined || v.right !== undefined)
    );

    if (data.length === 0) {
      container.innerHTML = "<p>No valid battles found.</p>";
      return;
    }

    // --- FIRST REAL BATTLE ---
    const battle = data[0];
    const leftID = getYouTubeID(battle.left);
    const rightID = getYouTubeID(battle.right);

    const leftVotes = voteCounts[0]?.left || 0;
    const rightVotes = voteCounts[0]?.right || 0;

    // --- LAST VALID SOUNDCLOUD URL ---
    const validSoundCloudRows = rawData.filter(
      r => r && r.soundcloud && r.soundcloud.includes("soundcloud.com")
    );

    const lastSoundCloudURL =
      validSoundCloudRows.length > 0
        ? validSoundCloudRows[validSoundCloudRows.length - 1].soundcloud
        : null;

    const leftURL =
      "https://www.youtube.com/embed/" +
      leftID +
      "?autoplay=1&mute=1&playsinline=1&controls=1&rel=0&modestbranding=1";

    const rightURL =
      "https://www.youtube.com/embed/" +
      rightID +
      "?autoplay=1&mute=1&playsinline=1&controls=1&rel=0&modestbranding=1";

    const battleHTML = `
      <div class="battle-card">
        <div class="battle-wrapper">

          <div class="battle-column">
            <div class="video-box">
              <div class="video-overlay">Dancer Left</div>
              <iframe src="${leftURL}" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
            <div class="vote-count">Votes: ${leftVotes}</div>
            <button class="vote-button" onclick="vote(0, 'left')">Vote Left</button>
          </div>

          <div class="battle-column">
            <div class="video-box">
              <div class="video-overlay">Dancer Right</div>
              <iframe src="${rightURL}" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
            <div class="vote-count">Votes: ${rightVotes}</div>
            <button class="vote-button" onclick="vote(0, 'right')">Vote Right</button>
          </div>

        </div>
      </div>
    `;

    container.innerHTML = battleHTML;

    // --- TINY SOUNDCLOUD PLAYER ---
    if (lastSoundCloudURL) {
      const embedURL =
        "https://w.soundcloud.com/player/?url=" +
        encodeURIComponent(lastSoundCloudURL) +
        "&visual=false&show_artwork=false&show_user=false&height=20";

      soundcloudContainer.innerHTML = `
        <iframe 
          src="${embedURL}"
          frameborder="0"
          allow="autoplay"
          style="width:100%; height:20px;">
        </iframe>
      `;
    } else {
      soundcloudContainer.innerHTML = `
        <div style="color:white; text-align:center; padding:10px;">
          <p>No SoundCloud track found.</p>
        </div>
      `;
    }

  } catch (err) {
    container.innerHTML = "<p>Error loading battle.</p>";
    soundcloudContainer.innerHTML = "<p>Unable to load SoundCloud player.</p>";
  }
}
