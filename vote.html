<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dance-Offs: Vote</title>

  <link rel="stylesheet" href="style2.css?v=1050">
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    .video-slot {
      min-height: 260px;
      background: #000;
      border-radius: 8px;
      position: relative;
    }
    .battle-frame {
      width: 100%;
      height: 260px;
      border-radius: 8px;
      border: none;
    }
    .blocker {
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      cursor:default;
      z-index:10;
    }
    .vote-btn {
      margin-top: 20px;
      padding: 14px 30px;
      font-size: 22px;
      font-weight: 700;
      background: #ffcc00;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: #000;
      width: 200px;
      box-shadow: 0 0 10px #ffcc00;
    }
    .vote-btn:hover {
      background: #ffe066;
      box-shadow: 0 0 14px #ffe066;
    }
  </style>
</head>

<body>

  <!-- NAVIGATION -->
  <nav class="navbar">
    <a href="index.html">Home</a>
    <div class="dropdown"><a href="dancers.html">Dancers</a></div>
    <div class="dropdown"><a href="djs.html">DJs</a></div>
    <a href="vote.html" class="active">Vote</a>
    <a href="prizes.html">Prizes</a>
    <div class="dropdown"><a href="shop.html">Shop</a></div>
  </nav>

  <main class="page-container" style="text-align:center;">

    <h1 class="instruction-line">Vote for the Winner</h1>

    <table class="battle-table" cellspacing="10" align="center">
      <tr>
        <td class="battle-cell">
          <div id="leftVideo" class="video-slot"></div>
          <button class="vote-btn" onclick="payAndVote('LEFT')">Vote Left</button>
        </td>

        <td class="battle-cell">
          <div id="rightVideo" class="video-slot"></div>
          <button class="vote-btn" onclick="payAndVote('RIGHT')">Vote Right</button>
        </td>
      </tr>
    </table>

  </main>

  <footer class="footer">
    © 2026 Dance-Offs — Built by Baz
  </footer>

  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=GBP"></script>

  <script>
    const endpoint =
      "https://script.google.com/macros/s/AKfycbwuOUEAuAE4CfauFw9Xxv3BJenwCUaUNakrb7DTeTjJLZMK8S1hCXbcLRBHCY3FoFZD_g/exec";

    let currentLeft = "";
    let currentRight = "";
    let battleID = "";

    function extractID(url) {
      if (!url) return null;
      const match = url.match(/(?:youtu\.be\/|watch\?v=|\/embed\/|\/shorts\/)([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }

    function embed(id) {
      return `
        <div style="position:relative;">
          <iframe 
            class="battle-frame"
            src="https://www.youtube.com/embed/${id}?autoplay=1&mute=1&loop=1&playlist=${id}&modestbranding=1&rel=0&disablekb=1"
            allow="autoplay; encrypted-media"
            allowfullscreen>
          </iframe>
          <div class="blocker"></div>
        </div>
      `;
    }

    // ⭐ Load current battle
    function loadBattle() {
      fetch(endpoint + "?mode=getbattle")
        .then(r => r.json())
        .then(data => {
          currentLeft = data.left;
          currentRight = data.right;

          const idL = extractID(currentLeft);
          const idR = extractID(currentRight);

          if (idL) document.getElementById("leftVideo").innerHTML = embed(idL);
          if (idR) document.getElementById("rightVideo").innerHTML = embed(idR);

          // battleID = row index is not needed — frontend sends the URL
          battleID = Date.now().toString(); // unique per vote session
        });
    }

    loadBattle();

    // ⭐ PayPal → POST to backend
    function payAndVote(side) {
      paypal.Buttons({
        createOrder: function(data, actions) {
          return actions.order.create({
            purchase_units: [{
              amount: { value: "1.50" }
            }]
          });
        },

        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {

            const tx = details.id;

            const payload = {
              side: side,
              tx: tx,
              battle: battleID
            };

            fetch(endpoint, {
              method: "POST",
              body: JSON.stringify(payload)
            })
            .then(r => r.text())
            .then(t => {
              alert("Vote recorded! Thank you.");
              window.location.href = "results.html";
            });
          });
        }

      }).render("body"); // PayPal injects buttons dynamically
    }
  </script>

</body>
</html>
